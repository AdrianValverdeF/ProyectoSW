<section class="events-section">
    <h2>Próximos Eventos</h2>
    <% if (!eventos || eventos.length===0) { %>
        <div class="no-events">
            <p>No hay eventos disponibles.</p>
        </div>
        <% } else { %>
            <% if (session?.esAdmin) { %>
                <button onclick="crearEvento(event)" class="admin-btn">Crear Evento</button>
                <% } %>

                    <% eventos.forEach(function(evento) { const deporte=evento.deporte ?
                        evento.deporte.toString().toLowerCase() : 'default' ; const equipoA=evento.equipoA ?
                        evento.equipoA.toString().toLowerCase() : 'default' ; const equipoB=evento.equipoB ?
                        evento.equipoB.toString().toLowerCase() : 'default' ; const fecha=evento.fecha ?
                        evento.fecha.toString() : 'Date TBD' ; %>
                        <div class="event-container" data-event-id="<%= evento.id %>">
                            <a href="/apuestas/<%= evento.id %>" class="event-banner" style="--team-a-image: url('/img/<%= deporte %>-<%= equipoA %>.jpg');
                          --team-b-image: url('/img/<%= deporte %>-<%= equipoB %>.jpg')">
                                <div class="team-background-container">
                                    <div class="team-background team-a-bg"></div>
                                    <div class="team-background team-b-bg"></div>
                                </div>

                                <div class="sport-logo">
                                    <img src="/img/<%= deporte %>.png" alt="<%= evento.deporte || 'Sport' %> logo">
                                </div>

                                <div class="teams-container">
                                    <div class="team">
                                        <span>
                                            <%= evento.equipoA %>
                                        </span>
                                    </div>
                                    <div class="vs">VS</div>
                                    <div class="team">
                                        <span>
                                            <%= evento.equipoB %>
                                        </span>
                                    </div>
                                </div>

                                <div class="event-date">
                                    <%= fecha %>
                                </div>
                            </a>

                            <% if (session?.esAdmin) { %>
                                <div class="event-actions">
                                    <button onclick="editarEvento('<%= evento.id %>', event)"
                                        class="admin-btn">Editar</button>
                                    <button onclick="eliminarEvento('<%= evento.id %>', event)"
                                        class="admin-btn danger">Eliminar</button>
                                </div>
                                <% } %>
                        </div>
                        <% }); %>
                            <% } %>
</section>

<div id="deleteConfirmationModal" class="confirmation-modal">
    <div class="modal-content">
        <h3>Confirmar Eliminación</h3>
        <p>¿Estás seguro de que deseas eliminar este evento?</p>
        <div class="modal-buttons">
            <button id="confirmDeleteBtn" class="admin-btn danger">Eliminar</button>
            <button id="cancelDeleteBtn" class="admin-btn">Cancelar</button>
        </div>
    </div>
</div>


<script>
    async function eliminarEvento(eventId, clickEvent) {
        clickEvent.stopPropagation();

        const modal = document.getElementById('deleteConfirmationModal');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const cancelBtn = document.getElementById('cancelDeleteBtn');

        modal.style.display = 'flex';

        const userConfirmed = await new Promise((resolve) => {

            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                resolve(true);
            };

            cancelBtn.onclick = () => {
                modal.style.display = 'none';
                resolve(false);
            };
        });

        if (!userConfirmed) return;

        try {
            const response = await fetch(`/contenido/eventos/${eventId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Error al eliminar el evento');
            }

            document.querySelector(`[data-event-id="${eventId}"]`).remove();

        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }

    function editarEvento(eventId, clickEvent) {
        clickEvent.stopPropagation();
        window.location.href = `/contenido/eventos/${eventId}/editar`;
    }

    function crearEvento(clickEvent) {
        clickEvent.stopPropagation();
        window.location.href = `/contenido/eventos/crear`;
    }

</script>